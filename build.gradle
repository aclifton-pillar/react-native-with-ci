plugins {
    id "base"
    id "com.wiredforcode.spawn" version '0.8.2'
}

description = 'build'
version = '0.0'

task npmInstall(group: "mobile") {
    ext.npmInstall = { ->
        exec {
            commandLine 'npm', 'install'
        }
    }

    ext.npmInstallDetoxCli = { ->
        exec {
            commandLine 'npm', 'install', '-g', 'detox-cli'
        }
    }

    doFirst {
        npmInstall();
        npmInstallDetoxCli()
    }
}

task installApplesimutils(group: "mobile") {
    ext.tapWix = { ->
        exec {
            commandLine 'brew', 'tap', 'wix/brew'
        }
    }

    ext.installApplesimutils = { ->
        exec {
            commandLine 'brew', 'install', 'applesimutils'
        }
    }

    doFirst {
        tapWix();
        installApplesimutils();
    }
}

task launchMetroBundler(type: SpawnProcessTask, group: "mobile") {
    command "npm run start"
    ready "Loading dependency graph, done."
}

task unitTest(group: "mobile") {
    ext.unitTest = { ->
        exec {
            commandLine 'npm', 'run', 'test'
        }
    }

    doFirst {
        unitTest()
    }
}

task iosTest(group: "mobile") {
    ext.detoxBuild = { ->
        exec {
            commandLine 'detox', 'build', '--configuration', 'ios.sim.debug'
        }
    }

    ext.detoxTest = { ->
        exec {
            commandLine 'detox', 'test',  '--configuration', 'ios.sim.debug'
        }
    }

    doFirst {
        detoxBuild();
        detoxTest();
    }
}
